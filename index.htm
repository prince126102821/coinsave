<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://apis.google.com; object-src 'none';">
    <title>零錢存錢管理</title>
    <script src="https://apis.google.com/js/api.js" defer></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f9f9f9; margin: 0; padding: 0; }
        header { background-color: #4CAF50; color: white; padding: 1em; text-align: center; }
        main { padding: 1em; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 1em; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-radius: 8px; }
        footer { text-align: center; padding: 1em; background-color: #4CAF50; color: white; position: fixed; bottom: 0; width: 100%; }
        #totalAmount { font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <header>
        <h1>零錢存錢管理</h1>
    </header>
    <main>
        <div class="container">
            <h2>我的存錢計畫</h2>
            <form id="savingForm">
                <label for="date">日期：</label>
                <input type="date" id="date" required>
                <br><br>
                <label for="coinType">零錢種類：</label>
                <select id="coinType">
                    <option value="1">1元</option>
                    <option value="5">5元</option>
                    <option value="10">10元</option>
                    <option value="50">50元</option>
                </select>
                <br><br>
                <label for="amount">數量：</label>
                <input type="number" id="amount" min="1" required>
                <br><br>
                <button type="button" id="depositButton">存款</button>
                <button type="button" id="withdrawButton">提款</button>
            </form>
            <button id="statisticsButton" style="margin-top: 10px;">統計零錢數量</button>
            <button id="clearButton" style="margin-top: 10px;">清除所有資料</button>
            <div id="totalAmount">總額：0元</div>
            <h2>存款紀錄</h2>
            <table border="1" width="100%">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>零錢種類</th>
                        <th>數量</th>
                        <th>總金額</th>
                    </tr>
                </thead>
                <tbody id="recordTable"></tbody>
            </table>
        </div>
    </main>
    <script>
        const SPREADSHEET_ID = '1yj9dRIJ3TLUMjV7PF_LiOrzdlKqxcPDIIbzfgZWdQIE';
        const CLIENT_ID = '617260742767-ngjtsdo857kpburnc3e6tp89o949fh6v.apps.googleusercontent.com';
        const SHEET_RANGE = 'sheet1!A:D';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const coinCounts = { '1元': 0, '5元': 0, '10元': 0, '50元': 0 };
        let totalAmount = 0;

        function initClient() {
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    clientId: CLIENT_ID,
                    scope: SCOPES
                }).then(() => {
                    console.log("Google Sheets API 初始化完成");
                    checkAuth();
                }).catch(error => {
                    console.error("API 初始化失敗：", error);
                });
            });
        }

        function checkAuth() {
            gapi.auth2.getAuthInstance().signIn().then(getRecords).catch(error => {
                console.error("登入失敗：", error);
            });
        }

        async function addRecord(date, coinType, amount, isDeposit) {
            if (!date || isNaN(coinType) || isNaN(amount) || amount <= 0) {
                alert("請輸入有效的日期、零錢種類和數量！");
                return;
            }
            if (!isDeposit && coinCounts[`${coinType}元`] < amount) {
                alert("提款失敗：零錢數量不足！");
                return;
            }

            try {
                const total = coinType * amount * (isDeposit ? 1 : -1);
                const values = [[date, `${coinType}元`, amount * (isDeposit ? 1 : -1), `${total}元`]];
                coinCounts[`${coinType}元`] += isDeposit ? amount : -amount;

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: SHEET_RANGE,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values },
                });

                totalAmount += total;
                document.getElementById('totalAmount').textContent = `總額：${totalAmount}元`;
            } catch (error) {
                console.error("新增紀錄失敗：", error);
            }
        }

        document.getElementById('depositButton').addEventListener('click', () => {
            addRecord(document.getElementById('date').value, parseInt(document.getElementById('coinType').value), parseInt(document.getElementById('amount').value), true);
        });

        document.getElementById('withdrawButton').addEventListener('click', () => {
            addRecord(document.getElementById('date').value, parseInt(document.getElementById('coinType').value), parseInt(document.getElementById('amount').value), false);
        });

        initClient();
    </script>
</body>
</html>
